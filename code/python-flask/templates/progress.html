<!DOCTYPE html>
<html>
<head>
    <title>Task Progress</title>
    <style>
        /* So newlines in textContent actually show up */
        #progress {
            white-space: pre-line;
        }
    </style>
</head>
<body>
    {# Link to Copilot code https://copilot.microsoft.com/shares/J7AvsZpX9CV46Js3yXQm4 #}
    <h2>Task Progress</h2>
    <div id="progress">
        Waiting for updates for {{ lab_id }}... {{ task_id }}, connecting to {{ api_url }}
    </div>

    {# Link that will be populated when the lab is ready #}
    <a id="shelly-link" style="display:block; margin-top:1em;">Start lab</a>

    <script>
        const labID = "{{ lab_id }}";
        const taskId = "{{ task_id }}";
        const apiUrl = "{{ api_url }}";  // match case
        const source = new EventSource(`${apiUrl}/stream/${taskId}`);

        // UUID for this launched lab, passed from Flask
        const labLaunchUUID = "{{ lab_launch_uuid }}";

        source.onopen = function () {
            console.log("SSE connection established");
        };

        source.onerror = function (err) {
            console.error("SSE connection error", err);
            // Optional: source.close();
        };

        source.onmessage = function (event) {
            console.log("Raw message:", event.data);
            console.log("Event.data type:", typeof event.data);

            let fixedJson = event.data;
            // If your backend eventually sends valid JSON, just do:
            // const data = JSON.parse(event.data);
            const data = JSON.parse(fixedJson.replace(/'/g, '"'));

            const progressEl = document.getElementById("progress");
            progressEl.textContent += `\nStatus: ${data.status} ${data.output}`;

            if (data.status === "FINISHED") {
                progressEl.textContent += "\nâœ… Task completed! Ready to enter the Lab...";

                // Build link to Shelly console with launch_id as a query param
                const baseShelly = "{{ url_for('shelly') }}";
                //const shellyURL = `${baseShelly}?launch_id=${encodeURIComponent(labLaunchUUID)};
                const shellyURL = `${baseShelly}?launch_id=${encodeURIComponent(labLaunchUUID)}${labLaunchUUID ? `&user_id={{ user_email }}` : ''}`;

                const linkEl = document.getElementById("shelly-link");
                linkEl.href = shellyURL;
                linkEl.textContent = "Open Shelly console";
                linkEl.target = "_blank";

                console.log("Shelly URL:", shellyURL);

                source.close();
            }
        };
    </script>
</body>
</html>
